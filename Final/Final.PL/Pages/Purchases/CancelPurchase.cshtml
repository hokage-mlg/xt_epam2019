@using Final.Ioc;
@{
    Page.Title = "Cancel Purchase";
    Layout = "~/Layouts/_MainLayout.cshtml";
    int id = 0;
    string errorMessage = null;
    string stop = null;
}
<h3 style="padding-left:40px">Cancel purchase</h3>
@if (IsPost)
{
    if (!int.TryParse(Request["Id"], out id))
    {
        errorMessage = "Please, input your purchase id.";
    }
    else
    {
        var user = DependencyResolver.UserLogic.GetByLogin(User.Identity.Name);
        var purchases = DependencyResolver.PurchaseLogic.GetPurchasesByUserId(user.Id);
        foreach (var purchase in purchases)
        {
            stop = "false";
            if (id == purchase.Id)
            {

                if (DependencyResolver.UserLogic.CancelPurchase(user.Id, purchase.Id))
                {
                    errorMessage = null;
                    var books = DependencyResolver.BookLogic.GetBooksByPurchaseId(purchase.Id);
                    foreach (var book in books)
                    {
                        DependencyResolver.BookLogic.RemoveBookFromPurchase(book.Id, purchase.Id);
                        DependencyResolver.BookLogic.ChangeCount(book.Id, book.Count + 1);
                    }
                    <div class="alert alert-info" style="padding-left:40px">Operation was completed</div>
                }
                else
                {
                    Response.Redirect("~/404.cshtml");
                }
                stop = "true";
                break;
            }
        }
    }
}
@if (errorMessage != null || stop != "true" || stop == "false")
{
    <div class="alert alert-light" style="padding-left:40px">Please, input correct values</div>
}
<div class="main" style="padding-left:40px">
    <form action="~/Pages/Purchases/CancelPurchase.cshtml" method="post">
        <div>
            <label>Purchase Id for cancel: </label>
            <input class="form-control" style="width:200px" type="text" name="Id" id="Id" />
        </div>
        <br />
        <button class="btn btn-primary" style="width:200px">Submit</button>
    </form>
</div>
<br />
<br />